<?xml version="1.0" encoding="UTF-8"?>
<!--
    Miscellaneous UK channel verbs.
-->
<beans xmlns="http://www.springframework.org/schema/beans"
    default-lazy-init="true"
    xmlns:c="http://www.springframework.org/schema/c"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <!--
        Import commonly used beans.
    -->
    <import resource="classpath:common-beans.xml"/>

    <!--
        Import channel-specific beans.
    -->
    <import resource="classpath:uk/beans.xml"/>

    <!--
        Import UK federation registration policy for new metadata.
    -->
    <import resource="classpath:uk/policy-registration.xml"/>

    <!--
        Import UK federation registered entities policy.
    -->
    <import resource="classpath:uk/policy-registered-entity.xml"/>

    <!--
        ***************************************
        ***                                 ***
        ***   V E R B   P I P E L I N E S   ***
        ***                                 ***
        ***************************************
    -->

    <!--
        statistics

        Stand-alone statistics generation.
    -->
    <bean id="statistics" parent="mda.SimplePipeline">
        <property name="stages">
            <list>
                <ref bean="policy.uk_registeredEntities"/>
                <ref bean="uk_statisticsPipeline"/>
            </list>
        </property>
    </bean>

    <!--
        ***********************
        ***                 ***
        ***   V E R I F Y   ***
        ***                 ***
        ***********************
    -->

    <bean id="verify" parent="mda.SimplePipeline">
        <property name="stages">
            <list>
                <!--
                    policy.uk_registeredEntities performs all
                    per-entity checks and terminates if
                    any of them fail.
                -->
                <ref bean="policy.uk_registeredEntities"/>

                <!--
                    Now build an aggregate so that we can perform
                    checks across the whole aggregate, such as
                    entityID uniqueness.
                -->
                <ref bean="uk_assemble"/>
                <ref bean="checkSchemas"/>
                <ref bean="check_aggregate"/>
                <ref bean="errorTerminatingFilter"/>
            </list>
        </property>
    </bean>

    <!--
        *********************************
        ***                           ***
        ***   C H E C K   P O R T S   ***
        ***                           ***
        *********************************
    -->

    <bean id="checkPorts" parent="mda.SimplePipeline">
        <property name="stages">
            <list>
                <ref bean="policy.uk_registeredEntities"/>

                <!--
                    The next five stages ensure that any errors are reported
                    in entity ID order, even on systems where the native order
                    (which tends to reflect the file enumeration ordering)
                    is arbitrary.  Ideally this should be handled by an explicit
                    ordering stage.

                    The actual reordering is performed by the uk_assemble/disassemble
                    stages; the subsequent "populate" stages restore the item
                    metadata discarded by the uk_assemble stage.
                -->
                <ref bean="uk_assemble"/>
                <ref bean="disassemble"/>
                <ref bean="populateItemIds"/>
                <ref bean="uk_populateIds"/>
                <ref bean="populateRegistrationAuthorities"/>

                <ref bean="check_vhosts"/>
                <ref bean="errorAnnouncingFilter"/>
            </list>
        </property>
    </bean>

    <!--
        ***********************************
        ***                             ***
        ***   C H E C K   F U T U R E   ***
        ***                             ***
        ***********************************
    -->

    <bean id="checkFuture" parent="mda.SimplePipeline">
        <property name="stages">
            <list>
                <ref bean="policy.uk_registeredEntities"/>

                <!--
                    The next five stages ensure that any errors are reported
                    in entity ID order, even on systems where the native order
                    (which tends to reflect the file enumeration ordering)
                    is arbitrary.  Ideally this should be handled by an explicit
                    ordering stage.

                    The actual reordering is performed by the uk_assemble/disassemble
                    stages; the subsequent "populate" stages restore the item
                    metadata discarded by the uk_assemble stage.
                -->
                <ref bean="uk_assemble"/>
                <ref bean="disassemble"/>
                <ref bean="populateItemIds"/>
                <ref bean="uk_populateIds"/>
                <ref bean="populateRegistrationAuthorities"/>

                <!--
                    Additional X.509 certificate checks, over and above those
                    performed in policy.uk_registeredEntities.
                -->
                <bean id="checkCertificates" parent="mda.X509ValidationStage">
                    <property name="validators">
                        <list>
                            <!-- none at present -->
                        </list>
                    </property>
                </bean>

                <ref bean="check_future"/>
                <ref bean="errorAnnouncingFilter"/>
            </list>
        </property>
    </bean>

    <!--
        *****************************************
        ***                                   ***
        ***   M E T A D A T A   I M P O R T   ***
        ***                                   ***
        *****************************************
    -->

    <!--
        fetchImportMetadata

        Fetches the contents of the file used to hold metadata to be imported
        into a UK federation fragment file.
    -->
    <bean id="fetchImportMetadata" parent="mda.DOMFilesystemSourceStage">
        <property name="parserPool" ref="parserPool"/>
        <property name="source">
            <bean parent="File">
                <constructor-arg value="${entities.dir}/import.xml"/>
            </bean>
        </property>
    </bean>

    <!--
        serializeImportedMetadata

        Serialise the fragment file just imported.
    -->
    <bean id="serializeImportedMetadata" parent="mda.SerializationStage">
        <property name="serializer" ref="serializer"/>
        <property name="outputFile">
            <bean parent="File">
                <constructor-arg value="${entities.dir}/imported.xml"/>
            </bean>
        </property>
    </bean>


    <!--
        #################################################
        ###                                           ###
        ###   U K   E X P O R T   A S   I M P O R T   ###
        ###                                           ###
        #################################################
    -->

    <bean id="serializeImported" parent="mda.SerializationStage">
        <property name="serializer" ref="serializer"/>
        <property name="outputFile">
            <bean parent="File">
                <constructor-arg value="${mdx.dir}/uk/imported.xml"/>
            </bean>
        </property>
    </bean>

    <bean id="importExported" parent="mda.SimplePipeline">
        <property name="stages">
            <list>
                <ref bean="uk_exportedEntities"/>
                <ref bean="standardImportActions"/>
                <ref bean="check_shib_regscope"/>
                <ref bean="standardImportTail"/>
                <ref bean="serializeImported"/>
            </list>
        </property>
    </bean>

    <bean id="importExportedRaw" parent="mda.SimplePipeline">
        <property name="stages">
            <list>
                <ref bean="uk_exportAggregate"/>
                <ref bean="serializeImported"/>
            </list>
        </property>
    </bean>

    <alias alias="import"    name="importExported"/>
    <alias alias="importRaw" name="importExportedRaw"/>
</beans>
